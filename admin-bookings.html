<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Counselling Bookings - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Garamond', serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Navigation Bar */
        nav {
            background: linear-gradient(135deg, #8b6f47 0%, #a0826d 100%);
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-left: 6px solid #d4af37;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            color: #f5e6d3;
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .nav-center {
            display: flex;
            gap: 30px;
            align-items: center;
            flex: 1;
            justify-content: center;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            list-style: none;
        }

        .nav-links a {
            color: #f5e6d3;
            text-decoration: none;
            font-size: 16px;
            transition: color 0.3s ease, text-shadow 0.3s ease;
            border-bottom: 2px solid transparent;
            padding-bottom: 5px;
        }

        .nav-links a:hover {
            color: #d4af37;
            text-shadow: 0 0 8px rgba(212, 175, 55, 0.5);
        }

        .nav-admin-links {
            display: flex;
            gap: 10px;
            list-style: none;
            flex-wrap: wrap;
        }

        .nav-admin-links li {
            white-space: nowrap;
        }

        .nav-admin-links a {
            color: #f5e6d3;
            text-decoration: none;
            font-size: 13px;
            transition: color 0.3s ease;
            border-bottom: 2px solid transparent;
            padding: 5px 8px;
            display: inline-block;
        }

        .nav-admin-links a.active {
            color: #d4af37;
            border-bottom: 2px solid #d4af37;
        }

        .nav-admin-links a:hover {
            color: #d4af37;
        }

        .nav-right {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .logout-btn {
            background: linear-gradient(135deg, #d4af37 0%, #c9a961 100%);
            color: #2c3e50;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 2px solid #8b6f47;
            font-size: 12px;
            white-space: nowrap;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #e6c547 0%, #d4af37 100%);
            transform: scale(1.05);
        }

        .admin-badge {
            background: #c1440e;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                gap: 10px;
            }

            .nav-center {
                flex-direction: column;
                gap: 10px;
            }

            .nav-admin-links a {
                font-size: 12px;
                padding: 4px 6px;
            }

            .logout-btn {
                padding: 6px 12px;
                font-size: 11px;
            }
        }

        /* Unauthorized page */
        .unauthorized {
            text-align: center;
            padding: 80px 20px;
            background: linear-gradient(135deg, #f5e6d3 0%, #e8d7c3 100%);
            border-radius: 10px;
            border: 3px solid #c1440e;
            margin-top: 50px;
        }

        .unauthorized h1 {
            color: #c1440e;
            font-size: 48px;
            margin-bottom: 15px;
        }

        .unauthorized p {
            color: #666;
            font-size: 18px;
            margin-bottom: 30px;
        }

        .unauthorized a {
            background: linear-gradient(135deg, #8b6f47 0%, #a0826d 100%);
            color: #f5e6d3;
            padding: 12px 30px;
            border-radius: 5px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .unauthorized a:hover {
            background: linear-gradient(135deg, #a0826d 0%, #b5956d 100%);
        }

        /* Footer */
        footer {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #f5e6d3;
            text-align: center;
            padding: 25px;
            margin-top: 50px;
            border-top: 3px solid #d4af37;
            font-size: 14px;
        }

        footer p {
            margin: 0;
            opacity: 0.9;
        }

        header {
            background: linear-gradient(135deg, #5a9fb8 0%, #4a8ca3 100%);
            padding: 25px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            color: white;
        }

        h1 {
            font-size: 32px;
            font-weight: normal;
            letter-spacing: 1px;
        }

        .subtitle {
            margin-top: 5px;
            opacity: 0.9;
            font-size: 16px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: linear-gradient(135deg, #f5e6d3 0%, #e8d7c3 100%);
            border-radius: 10px;
            padding: 25px;
            border: 3px solid #8b6f47;
        }

        .panel-title {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bookings-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .booking-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #5a9fb8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .booking-item.completed {
            opacity: 0.6;
            border-left-color: #95a5a6;
        }

        .booking-info {
            flex: 1;
        }

        .booking-date {
            font-weight: bold;
            color: #2c5f75;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .booking-details {
            font-size: 14px;
            color: #555;
        }

        .booking-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Georgia', serif;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-complete {
            background: #27ae60;
            color: white;
        }

        .btn-complete:hover {
            background: #229954;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .btn-add {
            background: linear-gradient(135deg, #5a9fb8 0%, #4a8ca3 100%);
            color: white;
            padding: 12px 20px;
            width: 100%;
            margin-top: 15px;
        }

        .btn-add:hover {
            background: linear-gradient(135deg, #4a8ca3 0%, #3a7c93 100%);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #8b6f47;
            border-radius: 5px;
            font-size: 14px;
            font-family: 'Georgia', serif;
            background: white;
        }

        .calendar-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calendar-day {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e8d7c3;
        }

        .calendar-day.booked {
            background: #ffeaa7;
            border-color: #fdcb6e;
        }

        .calendar-day.unavailable {
            background: #dfe6e9;
            border-color: #b2bec3;
        }

        .calendar-day-label {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .calendar-day-date {
            font-size: 12px;
            color: #666;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #8b6f47;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #5a9fb8;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .unavailable-list {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .unavailable-item {
            padding: 8px;
            border-bottom: 1px solid #e8d7c3;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .unavailable-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 968px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <div class="nav-brand">üìö Reader's Haven</div>
            <div class="nav-center">
                <ul class="nav-links">
                    <li><a href="shopping-cart.html">Shop Books</a></li>
                    <li><a href="counselling.html">Counselling Support</a></li>
                </ul>
                <ul class="nav-admin-links">
                    <li><a href="admin-bookings.html" class="active">Admin - Bookings</a></li>
                    <li><a href="admin-orders.html">Admin - Orders</a></li>
                    <li><a href="admin-products.html">Admin - Products</a></li>
                </ul>
            </div>
            <div class="nav-right">
                <span class="admin-badge">üîê Admin</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </nav>
    </div>

    <div id="adminContent" style="display: none;">
        <div class="container">
            <header>
                <h1>üìä Counselling Bookings Dashboard</h1>
                <p class="subtitle">Manage appointments, availability, and sessions | <span id="lastUpdate" style="font-size: 12px; color: #888;">Live updates enabled</span></p>
            </header>

            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                <div class="stat-number" id="totalBookings">0</div>
                <div class="stat-label">Total Bookings</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="upcomingBookings">0</div>
                <div class="stat-label">Upcoming</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedBookings">0</div>
                <div class="stat-label">Completed</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Bookings Panel -->
            <div class="panel">
                <h2 class="panel-title">üìÖ All Bookings</h2>
                <div class="bookings-list" id="bookingsList"></div>
            </div>

            <!-- Availability Management -->
            <div class="panel">
                <h2 class="panel-title">‚öôÔ∏è Manage Availability</h2>
                
                <h3 style="color: #2c5f75; font-size: 18px; margin-bottom: 15px;">Block a Date</h3>
                <div class="form-group">
                    <label class="form-label">Select Date</label>
                    <input type="date" class="form-input" id="blockDate">
                </div>
                <div class="form-group">
                    <label class="form-label">Reason (optional)</label>
                    <input type="text" class="form-input" id="blockReason" placeholder="Holiday, Personal day, etc.">
                </div>
                <button class="btn btn-add" onclick="blockDate()">Block This Date</button>

                <h3 style="color: #2c5f75; font-size: 18px; margin: 25px 0 15px;">Blocked Dates</h3>
                <div class="unavailable-list" id="unavailableList"></div>
            </div>
        </div>

        <!-- Quick Actions Panel -->
        <div class="panel">
            <h2 class="panel-title">üîß Quick Actions</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <button class="btn btn-add" onclick="exportBookings()">üì• Export Bookings (CSV)</button>
                <button class="btn btn-add" onclick="clearCompleted()">üóëÔ∏è Clear Completed Sessions</button>
                <button class="btn btn-add" onclick="viewUpcoming()">üìÜ View Next 7 Days</button>
            </div>
        </div>
    </div>
    </div>

    <div id="unauthorizedContent" style="display: block;">
        <div class="container">
            <div class="unauthorized">
                <h1>üîí Access Denied</h1>
                <p>You must be logged in as an admin to access this page.</p>
                <button class="unauthorized-btn" onclick="openLoginModal()" style="background: linear-gradient(135deg, #8b6f47 0%, #a0826d 100%); color: #f5e6d3; border: none; padding: 12px 30px; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; margin: 15px 10px 0 0; transition: all 0.3s ease;">Login Here</button>
                <a href="shopping-cart.html" style="display: inline-block; margin: 15px 0 0 10px;">Return to Home</a>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="login-modal" id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 2000; justify-content: center; align-items: center; flex-direction: column;">
        <div style="background: #f5e6d3; width: 90%; max-width: 400px; border-radius: 10px; padding: 40px; position: relative; border: 3px solid #8b6f47; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);">
            <span onclick="closeLoginModal()" style="position: absolute; top: 20px; right: 20px; font-size: 30px; cursor: pointer; color: #8b6f47; transition: color 0.3s ease;">&times;</span>
            <h2 style="font-size: 28px; font-weight: bold; color: #4A3F38; margin-bottom: 10px; text-align: center; font-family: 'Georgia', serif;">Admin Login</h2>
            <p style="font-size: 14px; color: #6B5D53; text-align: center; margin-bottom: 30px;">Enter your credentials to access admin features</p>
            
            <form id="loginForm" onsubmit="handleAdminLogin(event)">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #4A3F38; font-weight: bold; font-size: 14px;">Username</label>
                    <input type="text" id="loginUsername" placeholder="admin" required style="width: 100%; padding: 12px; border: 2px solid #C4A57B; border-radius: 5px; font-family: 'Georgia', serif; font-size: 14px; color: #4A3F38; background: #fff;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #4A3F38; font-weight: bold; font-size: 14px;">Password</label>
                    <input type="password" id="loginPassword" placeholder="password" required style="width: 100%; padding: 12px; border: 2px solid #C4A57B; border-radius: 5px; font-family: 'Georgia', serif; font-size: 14px; color: #4A3F38; background: #fff;">
                </div>

                <div id="loginError" style="color: #C85A5A; font-size: 13px; margin-top: 5px; display: none; margin-bottom: 15px;">Invalid username or password</div>

                <button type="submit" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #8b6f47 0%, #a0826d 100%); color: #f5e6d3; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; margin-top: 10px;">Login</button>
            </form>

            <div style="background: rgba(139, 115, 85, 0.1); border: 1px solid #C4A57B; padding: 12px; border-radius: 5px; margin-top: 20px; font-size: 12px; color: #4A3F38; text-align: center;">
                Demo Credentials:<br>
                Username: <strong>admin</strong><br>
                Password: <strong>admin123</strong>
            </div>
        </div>
    </div>

    <script>
        // Check authentication first
        function initializeAdmin() {
            let isAdmin = false;
            try {
                // Check both keys for backward compatibility
                isAdmin = localStorage.getItem('isAdmin') === 'true' || localStorage.getItem('isAdminLoggedIn') === 'true';
            } catch (e) {
                console.warn('‚ö†Ô∏è localStorage unavailable, falling back to in-memory flag', e);
                isAdmin = window.__isAdminFlag === true;
            }

            const adminContent = document.getElementById('adminContent');
            const unauthorizedContent = document.getElementById('unauthorizedContent');
            const status = (typeof localStorage !== 'undefined') ? localStorage.getItem('isAdmin') : 'localStorage unavailable';
            if (document.getElementById('debugStatus')) {
                document.getElementById('debugStatus').textContent = status || 'null';
            }
            
            console.log('üîç Admin Check:', {
                isAdmin: isAdmin,
                localStorageValue: status,
                adminContent: !!adminContent,
                unauthorizedContent: !!unauthorizedContent
            });

            if (isAdmin) {
                console.log('‚úÖ Admin detected - showing dashboard');
                if (adminContent) {
                    adminContent.style.display = 'block';
                    renderBookings();
                    renderUnavailableDates();
                    updateStats();
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('blockDate').setAttribute('min', today);
                }
                if (unauthorizedContent) unauthorizedContent.style.display = 'none';
            } else {
                console.log('‚ùå Not admin - showing access denied');
                if (adminContent) adminContent.style.display = 'none';
                if (unauthorizedContent) unauthorizedContent.style.display = 'block';
            }
        }

        function logout() {
            try {
                localStorage.setItem('isAdmin', 'false');
                localStorage.setItem('isAdminLoggedIn', 'false');
            } catch {}
            window.location.href = 'shopping-cart.html';
        }

        function openLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.justifyContent = 'center';
                modal.style.alignItems = 'center';
                modal.style.zIndex = '2000';
                console.log('‚úÖ Login modal opened');
            }
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('loginForm').reset();
        }

        function handleAdminLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            // Default credentials
            if (username === 'admin' && password === 'admin123') {
                try {
                    localStorage.setItem('isAdmin', 'true');
                    localStorage.setItem('isAdminLoggedIn', 'true');
                } catch (e) {
                    // Fallback when storage is blocked
                    window.__isAdminFlag = true;
                }
                closeLoginModal();
                initializeAdmin();
            } else {
                errorDiv.style.display = 'block';
            }
        }

        // Close login modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                loginModal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeLoginModal();
                    }
                });
            }
        });


        // Load data from API
        let bookedAppointments = [];
        let unavailableDates = [];
        let isLoading = false;

        // Fetch bookings from API
        async function fetchBookings() {
            try {
                isLoading = true;
                const response = await fetch('api/admin/get-bookings.php', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || '')
                    }
                });

                if (response.status === 401) {
                    openLoginModal();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    bookedAppointments = data.bookings || [];
                    renderBookings();
                } else {
                    console.error('Failed to fetch bookings:', data.message || data.error);
                }
            } catch (error) {
                console.error('Error fetching bookings:', error);
                console.log('Using cached data if available.');
            } finally {
                isLoading = false;
            }
        }

        // Save to database via API
        async function updateBookingStatus(bookingId, newStatus, notes = '') {
            try {
                const response = await fetch('api/admin/update-booking-status.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || '')
                    },
                    body: JSON.stringify({
                        bookingId: bookingId,
                        status: newStatus
                    })
                });

                if (response.status === 401) {
                    openLoginModal();
                    return false;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    // Refresh bookings list
                    await fetchBookings();
                    return true;
                } else {
                    console.error('Failed to update booking:', data.error);
                    showAlert('Error', 'Error: ' + (data.error || 'Failed to update booking'));
                    return false;
                }
            } catch (error) {
                console.error('Error updating booking:', error);
                showAlert('Error', 'Failed to update booking: ' + error.message);
                return false;
            }
        }

        // Render bookings list
        function renderBookings() {
            const container = document.getElementById('bookingsList');
            
            if (bookedAppointments.length === 0) {
                container.innerHTML = '<div class="empty-state">No bookings yet</div>';
                return;
            }

            // Sort by date and time
            const sorted = [...bookedAppointments].sort((a, b) => {
                const dateCompare = new Date(a.booking_date) - new Date(b.booking_date);
                if (dateCompare !== 0) return dateCompare;
                return a.booking_time.localeCompare(b.booking_time);
            });

            container.innerHTML = sorted.map((booking) => {
                const dateObj = new Date(booking.booking_date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });

                // Convert time to 12-hour format
                const [hour, minute] = booking.booking_time.split(':');
                const h = parseInt(hour);
                const ampm = h >= 12 ? 'PM' : 'AM';
                const displayHour = h % 12 || 12;
                const formattedTime = `${displayHour}:${minute} ${ampm}`;

                const statusClass = booking.status === 'completed' ? 'completed' : '';
                const isCompleted = booking.status === 'completed';

                return `
                    <div class="booking-item ${statusClass}">
                        <div class="booking-info">
                            <div class="booking-date">${formattedDate} at ${formattedTime} ${isCompleted ? '‚úì Completed' : ''}</div>
                            <div class="booking-details">
                                <strong>${booking.customer_name}</strong><br>
                                 ${booking.customer_email} |  ${booking.customer_phone}<br>
                                ${booking.notes ? ` ${booking.notes}` : ''}
                            </div>
                        </div>
                        <div class="booking-actions">
                            ${booking.status === 'pending' || booking.status === 'confirmed' ? `
                                <button class="btn btn-complete" onclick="markBookingComplete(${booking.id})">‚úì Complete</button>
                            ` : ''}
                            ${booking.status !== 'completed' ? `
                                <button class="btn btn-delete" onclick="deleteBookingById(${booking.id}, '${booking.booking_number || ''}')">Delete</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            updateStats();
        }

        // Mark booking as complete
        async function markBookingComplete(bookingId) {
            showConfirm('Complete Session', 'Mark this session as completed?', async (confirmed) => {
                if (!confirmed) return;
                const success = await updateBookingStatus(bookingId, 'completed');
                if (!success) {
                    showAlert('Error', 'Failed to mark booking as completed');
                }
            });
        }

        // Delete booking
        async function deleteBookingById(bookingId, bookingNumber = '') {
            showConfirm('Delete Booking', 'Delete this booking? This cannot be undone.', async (confirmed) => {
                if (!confirmed) return;
                try {
                    const response = await fetch('api/admin/delete-booking.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || '')
                        },
                        body: JSON.stringify({ bookingId: bookingId, bookingNumber: bookingNumber })
                    });

                    if (response.status === 401) {
                        openLoginModal();
                        return;
                    }

                    const responseText = await response.text();
                    let data = {};
                    try {
                        data = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error(responseText.substring(0, 200));
                    }

                    if (!response.ok || !data.success) {
                        throw new Error(data.message || `HTTP error! status: ${response.status}`);
                    }

                    await fetchBookings();
                } catch (error) {
                    console.error('Error deleting booking:', error);
                    // Silently refresh bookings - deletion may have succeeded even with error
                    await fetchBookings();
                }
            });
        }

        // Render unavailable dates
        function renderUnavailableDates() {
            const container = document.getElementById('unavailableList');
            
            if (unavailableDates.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No blocked dates</div>';
                return;
            }

            const sorted = [...unavailableDates].sort((a, b) => new Date(a.unavailable_date) - new Date(b.unavailable_date));

            container.innerHTML = sorted.map((item) => {
                const dateVal = item.unavailable_date || item.date;
                const dateObj = new Date(dateVal + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });

                const reasonText = item.reason ? '- ' + item.reason : '';

                return `
                    <div class="unavailable-item">
                        <span><strong>${formattedDate}</strong> ${reasonText}</span>
                        <button class="btn btn-delete" style="padding: 5px 10px; font-size: 12px;" onclick="unblockDateById(${item.id})">Unblock</button>
                    </div>
                `;
            }).join('');
        }

        // Block a date via API
        async function blockDate() {
            const dateInput = document.getElementById('blockDate');
            const date = dateInput ? dateInput.value : '';
            const reason = document.getElementById('blockReason').value;

            if (!date) {
                showAlert('Invalid Date', 'Please select a date');
                return;
            }

            // Check if already blocked locally
            if (unavailableDates.some(d => d.unavailable_date === date)) {
                showAlert('Already Blocked', 'This date is already booked');
                return;
            }

            try {
                const response = await fetch('api/admin/add-unavailable-date.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || '')
                    },
                    body: JSON.stringify({
                        date: date,
                        reason: reason || 'Not available'
                    })
                });

                if (response.status === 401) {
                    openLoginModal();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    // Refresh unavailable dates
                    unavailableDates.push({
                        id: data.id,
                        unavailable_date: date,
                        reason: reason || 'Not available'
                    });
                    renderUnavailableDates();

                    // Clear form
                    document.getElementById('blockDate').value = '';
                    document.getElementById('blockReason').value = '';

                    showAlert('Success', `Date blocked: ${new Date(date).toLocaleDateString()}`);
                    fetchUnavailableDates();
                } else {
                    showAlert('Error', 'Error: ' + (data.message || data.error || 'Failed to block date'));
                }
            } catch (error) {
                console.error('Error blocking date:', error);
                showAlert('Error', 'Failed to block date: ' + error.message);
            }
        }

        // Unblock a date via API
        async function unblockDateById(dateId) {
            showConfirm('Unblock Date', 'Are you sure you want to unblock this date?', async (confirmed) => {
                if (!confirmed) return;
                try {
                    const response = await fetch('api/admin/delete-unavailable-date.php', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || '')
                        },
                        body: JSON.stringify({ id: dateId })
                    });

                    if (response.status === 401) {
                        openLoginModal();
                        return;
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.success) {
                        unavailableDates = unavailableDates.filter(d => d.id !== dateId);
                        renderUnavailableDates();
                    } else {
                        showAlert('Error', 'Error: ' + (data.error || 'Failed to unblock date'));
                    }
                } catch (error) {
                    console.error('Error unblocking date:', error);
                    showAlert('Error', 'Failed to unblock date: ' + error.message);
                }
            });
        }

        // Update statistics
        function updateStats() {
            const total = bookedAppointments.length;
            const completed = bookedAppointments.filter(b => b.status === 'completed').length;
            const upcoming = bookedAppointments.filter(b => b.status !== 'completed' && new Date(b.booking_date) >= new Date()).length;

            document.getElementById('totalBookings').textContent = total;
            document.getElementById('completedBookings').textContent = completed;
            document.getElementById('upcomingBookings').textContent = upcoming;
        }

        // Clear completed sessions
        async function clearCompleted() {
            showConfirm('Clear Completed', 'Remove all completed sessions from the list?', async (confirmed) => {
                if (!confirmed) return;
                // This would require a batch delete API or we just reload after filtering
                const completedIds = bookedAppointments.filter(b => b.status === 'completed').map(b => b.id);
                
                for (const id of completedIds) {
                    try {
                        await fetch('api/admin/delete-booking.php', {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || '')
                            },
                            body: JSON.stringify({ id: id })
                        });
                    } catch (error) {
                        console.error('Error deleting completed booking:', error);
                    }
                }
                
                await fetchBookings();
                showAlert('Success', 'Completed sessions cleared');
            });
        }

        // Export bookings to CSV
        function exportBookings() {
            let csv = 'Date,Time,Name,Email,Phone,Notes,Status\n';
            
            bookedAppointments.forEach(booking => {
                csv += `${booking.booking_date},${booking.booking_time},"${booking.customer_name}","${booking.customer_email}","${booking.customer_phone}","${booking.notes || ''}",${booking.status}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bookings-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // View upcoming week
        function viewUpcoming() {
            const upcoming = bookedAppointments.filter(b => {
                const bookingDate = new Date(b.booking_date);
                const today = new Date();
                const weekFromNow = new Date();
                weekFromNow.setDate(today.getDate() + 7);
                return b.status !== 'completed' && bookingDate >= today && bookingDate <= weekFromNow;
            });

            if (upcoming.length === 0) {
                showAlert('No Upcoming Sessions', 'No upcoming bookings in the next 7 days');
            } else {
                const list = upcoming.map(b => `${b.booking_date} ${b.booking_time} - ${b.customer_name}`).join('\n');
                showAlert('Upcoming Sessions', `Next 7 days:\n\n${list}`);
            }
        }

        // Initialize
        async function initializeAndRender() {
            await fetchBookings();
            await fetchUnavailableDates();
            updateStats();
        }

        initializeAndRender();

        // Set minimum date for blocking
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('blockDate').setAttribute('min', today);

        // Check authentication on page load
        initializeAdmin();

        // Real-time updates via polling every 30 seconds
        setInterval(async () => {
            await fetchBookings();
        }, 30000);
    </script>

    <footer>
        <p>&copy; <span id="year"></span> Reader's Haven. All rights reserved. | Admin Dashboard</p>
    </footer>

    <script>
        document.getElementById('year').textContent = new Date().getFullYear();
        
        // Initialize on DOMContentLoaded to ensure all elements are loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeAdmin();
            fetchUnavailableDates();
            // Use native HTML5 date input (no external flatpickr needed)
            const dateInput = document.getElementById('blockDate');
            if (dateInput) {
                // Set min date to today
                const today = new Date().toISOString().split('T')[0];
                dateInput.setAttribute('min', today);
            }
        });
        
        // Also initialize immediately in case DOM is already ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeAdmin);
        } else {
            initializeAdmin();
        }

        // Custom Modal System (Themed like shopping-cart.html)
        function showAlert(title, message, callback) {
            const modal = document.createElement('div');
            modal.className = 'custom-modal active';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #f5e6d3 0%, #e8d7c3 100%); padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 3px solid #8b6f47;">
                    <h2 style="color: #8b6f47; margin-bottom: 20px; font-size: 24px;">${title}</h2>
                    <p style="color: #2c3e50; margin-bottom: 25px; white-space: pre-line; line-height: 1.6;">${message}</p>
                    <button onclick="this.closest('.custom-modal').remove(); ${callback ? 'window.customAlertCallback && window.customAlertCallback()' : ''}" 
                            style="width: 100%; padding: 15px; background: linear-gradient(135deg, #8b6f47 0%, #a0826d 100%); color: #f5e6d3; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                        OK
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            if (callback) window.customAlertCallback = callback;
        }

        function showConfirm(title, message, callback) {
            const modal = document.createElement('div');
            modal.className = 'custom-modal active';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #f5e6d3 0%, #e8d7c3 100%); padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 3px solid #8b6f47;">
                    <h2 style="color: #8b6f47; margin-bottom: 20px; font-size: 24px;">${title}</h2>
                    <p style="color: #2c3e50; margin-bottom: 25px; white-space: pre-line; line-height: 1.6;">${message}</p>
                    <div style="display: flex; gap: 15px;">
                        <button onclick="window.customConfirmCallback && window.customConfirmCallback(true); this.closest('.custom-modal').remove();" 
                                style="flex: 1; padding: 15px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
                            Confirm
                        </button>
                        <button onclick="window.customConfirmCallback && window.customConfirmCallback(false); this.closest('.custom-modal').remove();" 
                                style="flex: 1; padding: 15px; background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.customConfirmCallback = callback;
        }

        function showPrompt(title, message, callback) {
            const modal = document.createElement('div');
            modal.className = 'custom-modal active';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #f5e6d3 0%, #e8d7c3 100%); padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 3px solid #8b6f47;">
                    <h2 style="color: #8b6f47; margin-bottom: 20px; font-size: 24px;">${title}</h2>
                    <p style="color: #2c3e50; margin-bottom: 15px;">${message}</p>
                    <input type="text" id="promptInput" style="width: 100%; padding: 12px; border: 2px solid #8b6f47; border-radius: 8px; margin-bottom: 20px; font-size: 14px; box-sizing: border-box;">
                    <div style="display: flex; gap: 15px;">
                        <button onclick="window.customPromptCallback && window.customPromptCallback(document.getElementById('promptInput').value); this.closest('.custom-modal').remove();" 
                                style="flex: 1; padding: 15px; background: linear-gradient(135deg, #8b6f47 0%, #a0826d 100%); color: #f5e6d3; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
                            Submit
                        </button>
                        <button onclick="this.closest('.custom-modal').remove();" 
                                style="flex: 1; padding: 15px; background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            setTimeout(() => document.getElementById('promptInput').focus(), 100);
            window.customPromptCallback = callback;
        }

        // Fetch unavailable dates
        async function fetchUnavailableDates() {
            try {
                const response = await fetch('api/get-unavailable-dates.php');
                const data = await response.json();
                
                if (data.success) {
                    // Normalize keys so UI code can use unavailable_date consistently
                    unavailableDates = (data.unavailable_dates || []).map(item => ({
                        id: item.id,
                        unavailable_date: item.unavailable_date || item.date,
                        reason: item.reason || ''
                    }));
                    renderUnavailableDates();
                }
            } catch (error) {
                console.error('Error fetching unavailable dates:', error);
            }
        }

    </script>
</body>
</html>
